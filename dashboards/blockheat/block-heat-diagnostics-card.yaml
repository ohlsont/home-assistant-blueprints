# Block Heat diagnostics card (modular architecture)
# Replace the automation id before use.
# Optional graph requires the custom component apexcharts-card.

type: vertical-stack
cards:
  - type: markdown
    title: Block Heat Diagnostics (Modular)
    content: |
      {% set auto = 'automation.block_heat_final' %}
      {% set inputs = state_attr(auto, 'blueprint_input') %}
      {% if inputs is none %}
      Set `auto` to your final arbiter automation entity id.
      {% else %}
      {% set policy = inputs['energy_saving_boolean'] %}
      {% set fallback = inputs['fallback_active_boolean'] %}
      {% set target_saving_entity = inputs['target_saving_helper'] %}
      {% set target_comfort_entity = inputs['target_comfort_helper'] %}
      {% set target_final_entity = inputs['target_final_helper'] %}
      {% set control_entity = inputs['control_number_entity'] %}

      {% set target_saving = states(target_saving_entity) | float(default=none) %}
      {% set target_comfort = states(target_comfort_entity) | float(default=none) %}
      {% set target_final = states(target_final_entity) | float(default=none) %}
      {% set control_current = states(control_entity) | float(default=none) %}

      {% set policy_saving = is_state(policy, 'on') %}
      {% set fallback_active = is_state(fallback, 'on') %}

      {% if policy_saving %}
        {% set selected_source = 'saving target helper' %}
      {% elif fallback_active %}
        {% set selected_source = 'fallback minimum clamp' %}
      {% else %}
        {% set selected_source = 'comfort target helper' %}
      {% endif %}

      {% set control_delta = none %}
      {% if target_final is number and control_current is number %}
        {% set control_delta = (target_final - control_current) | round(3) %}
      {% endif %}

      **Policy saving**: {{ 'ON' if policy_saving else 'OFF' }}
      **Fallback active**: {{ 'ON' if fallback_active else 'OFF' }}
      **Selected source**: {{ selected_source }}

      **Saving target helper**: {{ target_saving | round(2) if target_saving is number else 'unknown' }} °C
      **Comfort target helper**: {{ target_comfort | round(2) if target_comfort is number else 'unknown' }} °C
      **Final target helper**: {{ target_final | round(2) if target_final is number else 'unknown' }} °C
      **Control number (current)**: {{ control_current | round(2) if control_current is number else 'unknown' }} °C

      **Final - control delta**: {{ control_delta if control_delta is not none else 'unknown' }} °C
      ---
      **Policy price / cutoff**: {{ states('sensor.blockheat_policy_price') }} / {{ states('sensor.blockheat_policy_cutoff') }}
      **Policy transition**: {{ states('sensor.blockheat_policy_transition') }}
      **Final source**: {{ states('sensor.blockheat_final_source') }}
      **Fallback comfort min / trigger / release**:
      {{ states('sensor.blockheat_fallback_comfort_min') }} /
      {{ states('sensor.blockheat_fallback_trigger_threshold') }} /
      {{ states('sensor.blockheat_fallback_release_threshold') }}
      **Control write delta**: {{ states('sensor.blockheat_control_write_delta') }}
      **Daikin action**: {{ states('sensor.blockheat_daikin_action') }}
      **Floor action**: {{ states('sensor.blockheat_floor_action') }}
      **Policy flags**:
      blocked={{ states('binary_sensor.blockheat_policy_blocked_now') }},
      ignore_price={{ states('binary_sensor.blockheat_policy_ignore_by_price') }},
      ignore_pv={{ states('binary_sensor.blockheat_policy_ignore_by_pv') }},
      below_min_floor={{ states('binary_sensor.blockheat_policy_below_min_floor') }},
      enough_time={{ states('binary_sensor.blockheat_policy_enough_time_passed') }}
      **Fallback flags**:
      arm={{ states('binary_sensor.blockheat_fallback_arm_condition') }},
      cooldown_ok={{ states('binary_sensor.blockheat_fallback_cooldown_ok') }}
      **Control write applied**: {{ states('binary_sensor.blockheat_control_write_applied') }}
      {% endif %}

  - type: custom:apexcharts-card
    header:
      show: true
      title: Block Heat Targets (7d)
    graph_span: 7d
    span:
      start: day
    now:
      show: true
      label: Now
    yaxis:
      - id: temp
        decimals: 1
        min: 0
        max: 35
      - id: mode
        min: 0
        max: 1
        decimals: 0
        opposite: true
        show: true
    series:
      - entity: input_number.block_heat_target_saving
        name: Target saving
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: input_number.block_heat_target_comfort
        name: Target comfort
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: input_number.block_heat_target_final
        name: Target final
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: number.REPLACE_control_temperature
        name: Control number
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: input_boolean.REPLACE_energy_saving
        name: Policy saving
        yaxis_id: mode
        type: area
        opacity: 0.2
        transform: "return x === 'on' ? 1 : 0;"
        group_by:
          duration: 30min
          func: last
      - entity: input_boolean.block_heat_fallback_active
        name: Fallback active
        yaxis_id: mode
        type: line
        curve: stepline
        transform: "return x === 'on' ? 1 : 0;"
        group_by:
          duration: 30min
          func: last

  - type: entities
    title: Block Heat Entities (replace with yours)
    entities:
      - entity: input_boolean.REPLACE_energy_saving
        name: Energy saving boolean
      - entity: input_boolean.block_heat_fallback_active
        name: Fallback active
      - entity: input_number.block_heat_target_saving
        name: Target saving helper
      - entity: input_number.block_heat_target_comfort
        name: Target comfort helper
      - entity: input_number.block_heat_target_final
        name: Target final helper
      - entity: number.REPLACE_control_temperature
        name: Control temperature
      - entity: input_datetime.block_heat_fallback_last_trigger
        name: Fallback last trigger
      - entity: sensor.blockheat_policy_price
        name: Diagnostics policy price
      - entity: sensor.blockheat_policy_cutoff
        name: Diagnostics policy cutoff
      - entity: sensor.blockheat_policy_transition
        name: Diagnostics policy transition
      - entity: sensor.blockheat_final_source
        name: Diagnostics final source
      - entity: sensor.blockheat_fallback_comfort_min
        name: Diagnostics fallback comfort min
      - entity: sensor.blockheat_fallback_trigger_threshold
        name: Diagnostics fallback trigger threshold
      - entity: sensor.blockheat_fallback_release_threshold
        name: Diagnostics fallback release threshold
      - entity: sensor.blockheat_control_write_delta
        name: Diagnostics control write delta
      - entity: sensor.blockheat_daikin_action
        name: Diagnostics daikin action
      - entity: sensor.blockheat_floor_action
        name: Diagnostics floor action
      - entity: binary_sensor.blockheat_policy_blocked_now
        name: Diagnostics policy blocked now
      - entity: binary_sensor.blockheat_policy_ignore_by_price
        name: Diagnostics policy ignore by price
      - entity: binary_sensor.blockheat_policy_ignore_by_pv
        name: Diagnostics policy ignore by pv
      - entity: binary_sensor.blockheat_policy_below_min_floor
        name: Diagnostics policy below min floor
      - entity: binary_sensor.blockheat_policy_enough_time_passed
        name: Diagnostics policy enough time passed
      - entity: binary_sensor.blockheat_fallback_arm_condition
        name: Diagnostics fallback arm condition
      - entity: binary_sensor.blockheat_fallback_cooldown_ok
        name: Diagnostics fallback cooldown ok
      - entity: binary_sensor.blockheat_control_write_applied
        name: Diagnostics control write applied
