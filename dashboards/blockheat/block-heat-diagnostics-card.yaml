# Block Heat diagnostics card (custom integration runtime)
# Optional graph requires the custom component apexcharts-card.

type: vertical-stack
cards:
  - type: markdown
    title: Block Heat Diagnostics
    content: |
      {% set policy = 'binary_sensor.blockheat_energy_saving_active' %}
      {% set fallback = 'binary_sensor.blockheat_fallback_active' %}
      {% set target_saving_entity = 'sensor.blockheat_target_saving' %}
      {% set target_comfort_entity = 'sensor.blockheat_target_comfort' %}
      {% set target_final_entity = 'sensor.blockheat_target_final' %}
      {% set fallback_last_trigger = 'sensor.blockheat_fallback_last_trigger' %}
      {% set control_entity = 'number.REPLACE_control_temperature' %}

      {% set target_saving = states(target_saving_entity) | float(default=none) %}
      {% set target_comfort = states(target_comfort_entity) | float(default=none) %}
      {% set target_final = states(target_final_entity) | float(default=none) %}
      {% set control_current = states(control_entity) | float(default=none) %}

      {% set policy_saving = is_state(policy, 'on') %}
      {% set fallback_active = is_state(fallback, 'on') %}

      {% if policy_saving %}
        {% set selected_source = 'saving target' %}
      {% elif fallback_active %}
        {% set selected_source = 'fallback minimum clamp' %}
      {% else %}
        {% set selected_source = 'comfort target' %}
      {% endif %}

      {% set control_delta = none %}
      {% if target_final is number and control_current is number %}
        {% set control_delta = (target_final - control_current) | round(3) %}
      {% endif %}

      **Policy saving**: {{ 'ON' if policy_saving else 'OFF' }}
      **Fallback active**: {{ 'ON' if fallback_active else 'OFF' }}
      **Selected source**: {{ selected_source }}

      **Saving target**: {{ target_saving | round(2) if target_saving is number else 'unknown' }} °C
      **Comfort target**: {{ target_comfort | round(2) if target_comfort is number else 'unknown' }} °C
      **Final target**: {{ target_final | round(2) if target_final is number else 'unknown' }} °C
      **Control number (current)**: {{ control_current | round(2) if control_current is number else 'unknown' }} °C
      **Fallback last trigger**: {{ states(fallback_last_trigger) }}

      **Final - control delta**: {{ control_delta if control_delta is not none else 'unknown' }} °C

  - type: custom:apexcharts-card
    header:
      show: true
      title: Block Heat Targets (7d)
    graph_span: 7d
    span:
      start: day
    now:
      show: true
      label: Now
    yaxis:
      - id: temp
        decimals: 1
        min: 0
        max: 35
      - id: mode
        min: 0
        max: 1
        decimals: 0
        opposite: true
        show: true
    series:
      - entity: sensor.blockheat_target_saving
        name: Target saving
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: sensor.blockheat_target_comfort
        name: Target comfort
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: sensor.blockheat_target_final
        name: Target final
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: number.REPLACE_control_temperature
        name: Control number
        yaxis_id: temp
        group_by:
          duration: 30min
          func: avg
      - entity: binary_sensor.blockheat_energy_saving_active
        name: Policy saving
        yaxis_id: mode
        type: area
        opacity: 0.2
        transform: "return x === 'on' ? 1 : 0;"
        group_by:
          duration: 30min
          func: last
      - entity: binary_sensor.blockheat_fallback_active
        name: Fallback active
        yaxis_id: mode
        type: line
        curve: stepline
        transform: "return x === 'on' ? 1 : 0;"
        group_by:
          duration: 30min
          func: last

  - type: entities
    title: Block Heat Entities
    entities:
      - entity: binary_sensor.blockheat_energy_saving_active
        name: Energy saving active
      - entity: binary_sensor.blockheat_fallback_active
        name: Fallback active
      - entity: sensor.blockheat_target_saving
        name: Target saving
      - entity: sensor.blockheat_target_comfort
        name: Target comfort
      - entity: sensor.blockheat_target_final
        name: Target final
      - entity: number.REPLACE_control_temperature
        name: Control temperature
      - entity: sensor.blockheat_fallback_last_trigger
        name: Fallback last trigger
