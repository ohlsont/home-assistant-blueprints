blueprint:
  name: Block heat (outdoor-aware + efficient)
  description: >
    Uses an energy-saving policy boolean plus indoor/outdoor temperatures to
    control a heat pump's block/allow behavior with an efficient cold-boost.

    - Energy saving = ON:
      - If warm outside, block heating (virtual temperature).
      - If cold outside, set control temp to 1°C below setpoint to avoid
        direct electric heating.
    - Energy saving = OFF:
      - Compute a cold-boost from outdoor temperature and apply it to the
        heatpump setpoint, with indoor warm-gating and clamping.
  domain: automation

  input:
    section_policy:
      name: "Section — Policy"
      description: " "
      default: "Policy"
      selector:
        text:

    energy_saving_boolean:
      name: Policy — Energy saving boolean (from Energy Saving Policy)
      description: >
        The input_boolean entity managed by the
        [Energy Saving Policy](https://gist.github.com/ohlsont/72e2dc6ffb4d211e74da4f26a89f2e4a)
        blueprint. ON = “save energy now”, OFF = “don’t care”.
      selector:
        entity:
          domain: input_boolean
          multiple: false

    section_sensors:
      name: "Section — Sensors"
      description: " "
      default: "Sensors"
      selector:
        text:

    comfort_room_1_sensor:
      name: Sensors — Comfort room 1 temperature sensor
      description: First comfort room sensor (used for min-of-rooms reference)
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    comfort_room_2_sensor:
      name: Sensors — Comfort room 2 temperature sensor
      description: Second comfort room sensor (used for min-of-rooms reference)
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    storage_room_sensor:
      name: Sensors — Storage/buffer room temperature sensor
      description: Storage room sensor (monitor + cap only)
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    outdoor_temperature_sensor:
      name: Sensors — Outdoor temperature sensor
      description: Your actual outdoor temperature sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    section_control:
      name: "Section — Control"
      description: " "
      default: "Control"
      selector:
        text:

    controll_sensor:
      name: Control — Controllable sensor (MQTT number)
      description: The controllable temperature number your heat pump/Ohmigo reads
      selector:
        entity:
          domain: number
          integration: mqtt
          multiple: false

    heatpump_setpoint:
      name: Control — Heatpump setpoint (°C)
      description: Baseline setpoint that the heatpump is configured for
      default: 20
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    section_energy_saving:
      name: "Section — Energy saving"
      description: " "
      default: "Energy saving"
      selector:
        text:

    virtual_temperature:
      name: Energy saving — Virtual temperature (°C)
      description: Value to write when energy saving = ON and warm outside to block heating
      default: 20
      selector:
        number:
          min: 0
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    energy_saving_warm_shutdown_outdoor:
      name: Energy saving — Warm shutdown threshold (°C)
      description: Above this outdoor temperature, energy saving fully blocks heating
      default: 7
      selector:
        number:
          min: -10
          max: 20
          step: 0.5
          unit_of_measurement: "°C"

    section_cold_boost:
      name: "Section — Cold boost"
      description: " "
      default: "Cold boost"
      selector:
        text:

    comfort_target_c:
      name: Comfort — Target temperature (°C)
      description: Target temperature for comfort rooms
      default: 22
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    comfort_to_heatpump_offset_c:
      name: Comfort — Heatpump offset (°C)
      description: Heatpump control target = comfort target minus this offset
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "°C"

    storage_to_heatpump_offset_c:
      name: Comfort — Storage heatpump offset (°C)
      description: Heatpump control target = storage target minus this offset
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: "°C"

    storage_cap_c:
      name: Comfort — Storage room cap (°C)
      description: Maximum temperature for the storage/buffer room
      default: 25
      selector:
        number:
          min: 10
          max: 40
          step: 0.5
          unit_of_measurement: "°C"

    storage_target_c:
      name: Comfort — Storage room target (°C)
      description: Target temperature for the storage/buffer room
      default: 25
      selector:
        number:
          min: 10
          max: 40
          step: 0.5
          unit_of_measurement: "°C"

    comfort_satisfied_margin_c:
      name: Comfort — Satisfied margin (°C)
      description: Margin below target to consider a room satisfied
      default: 0.2
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "°C"

    maintenance_target_c:
      name: Comfort — Maintenance target (°C)
      description: Target temperature when all comfort rooms are satisfied
      default: 20
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    maintenance_min_c:
      name: Comfort — Maintenance minimum (°C)
      description: Do not set control temperature below this when holding maintenance
      default: 19
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    direct_electric_min_c:
      name: Electric assist — Minimum control temperature (°C)
      description: Control temperature allowed to intentionally trigger direct electric assist
      default: 18.0
      selector:
        number:
          min: 5
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    electric_fallback_minutes:
      name: Electric assist — Trigger delay (minutes)
      description: Minutes below target before electric assist can activate
      default: 30
      selector:
        number:
          min: 5
          max: 240
          step: 5
          unit_of_measurement: Minutes
          mode: slider

    electric_fallback_delta_c:
      name: Electric assist — Below-target delta (°C)
      description: How far below target triggers electric assist timer
      default: 0.5
      selector:
        number:
          min: 0
          max: 3
          step: 0.1
          unit_of_measurement: "°C"

    electric_fallback_cooldown_minutes:
      name: Electric assist — Cooldown (minutes)
      description: Cooldown after electric assist trigger before re-arming
      default: 60
      selector:
        number:
          min: 0
          max: 240
          step: 5
          unit_of_measurement: Minutes
          mode: slider

    electric_fallback_last_trigger:
      name: Electric assist — Last trigger timestamp helper
      description: Input datetime helper used to enforce cooldown reliably
      selector:
        entity:
          domain: input_datetime
          multiple: false

    cold_threshold:
      name: Cold boost — Threshold (°C)
      description: Outdoor temperature below which cold-boost starts
      default: 0
      selector:
        number:
          min: -30
          max: 10
          step: 0.5
          unit_of_measurement: "°C"

    max_boost:
      name: Cold boost — Max boost (°C)
      description: Maximum boost added to setpoint in cold weather
      default: 3
      selector:
        number:
          min: 0
          max: 8
          step: 0.5
          unit_of_measurement: "°C"

    boost_slope_c:
      name: Cold boost — Slope (°C per 1°C boost)
      description: How many °C colder gives +1°C boost
      default: 5
      selector:
        number:
          min: 1
          max: 12
          step: 1
          unit_of_measurement: "°C"

    warm_margin:
      name: Cold boost — Indoor warm margin (°C)
      description: Suppress cold-boost when indoor temp >= setpoint + margin
      default: 0.3
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "°C"

    section_timing:
      name: "Section — Timing"
      description: " "
      default: "Timing"
      selector:
        text:

    refresh_temperature_delay:
      name: Timing — Refresh interval (minutes) when saving = OFF
      description: How often to update the controllable temperature in cheap/don't-care periods
      default: 5
      selector:
        number:
          min: 0
          max: 10
          step: 0.25
          unit_of_measurement: Minutes
          mode: slider

    section_safety:
      name: "Section — Safety"
      description: " "
      default: "Safety"
      selector:
        text:

    min_write_delta:
      name: Safety — Minimum change to write (°C)
      description: Only update if the difference from current value is at least this much
      default: 0.2
      selector:
        number:
          min: 0
          max: 2
          step: 0.1
          unit_of_measurement: "°C"

    section_limits:
      name: "Section — Limits"
      description: " "
      default: "Limits"
      selector:
        text:

    mirror_min_c:
      name: Limits — Control temperature minimum (°C)
      description: Do not set control temperature below this value
      default: -50
      selector:
        number:
          min: -60
          max: 30
          step: 0.5
          unit_of_measurement: "°C"

    mirror_max_c:
      name: Limits — Control temperature maximum (°C)
      description: Do not set control temperature above this value
      default: 50
      selector:
        number:
          min: 0
          max: 60
          step: 0.5
          unit_of_measurement: "°C"

mode: restart
max_exceeded: silent

variables:
  es_bool: !input energy_saving_boolean
  comfort_room_1_sensor: !input comfort_room_1_sensor
  comfort_room_2_sensor: !input comfort_room_2_sensor
  storage_room_sensor: !input storage_room_sensor
  outdoor_temperature_sensor: !input outdoor_temperature_sensor
  controll_sensor: !input controll_sensor
  heatpump_setpoint: !input heatpump_setpoint
  virtual_temperature: !input virtual_temperature
  energy_saving_warm_shutdown_outdoor: !input energy_saving_warm_shutdown_outdoor
  comfort_target_c: !input comfort_target_c
  comfort_to_heatpump_offset_c: !input comfort_to_heatpump_offset_c
  storage_to_heatpump_offset_c: !input storage_to_heatpump_offset_c
  storage_cap_c: !input storage_cap_c
  storage_target_c: !input storage_target_c
  comfort_satisfied_margin_c: !input comfort_satisfied_margin_c
  maintenance_target_c: !input maintenance_target_c
  maintenance_min_c: !input maintenance_min_c
  direct_electric_min_c: !input direct_electric_min_c
  electric_fallback_minutes: !input electric_fallback_minutes
  electric_fallback_delta_c: !input electric_fallback_delta_c
  electric_fallback_cooldown_minutes: !input electric_fallback_cooldown_minutes
  electric_fallback_last_trigger: !input electric_fallback_last_trigger
  cold_threshold: !input cold_threshold
  max_boost: !input max_boost
  boost_slope_c: !input boost_slope_c
  warm_margin: !input warm_margin
  refresh_temperature_delay: !input refresh_temperature_delay
  min_write_delta: !input min_write_delta
  mirror_min_c: !input mirror_min_c
  mirror_max_c: !input mirror_max_c

trigger:
  # React fast to policy changes
  - platform: state
    entity_id: !input energy_saving_boolean

  # Make sure we start in the correct state after restart
  - platform: homeassistant
    event: start

  # Light "tick" to gently correct if something drifts
  - platform: time_pattern
    minutes: "/5"
    id: periodic

  - platform: template
    id: electric_fallback
    value_template: >-
      {% set r1 = states(comfort_room_1_sensor) | float(default=none) %}
      {% set r2 = states(comfort_room_2_sensor) | float(default=none) %}
      {% set comfort_min = [r1, r2] | select('number') | list | min(default=none) %}
      {% set target = comfort_target_c | float(22) %}
      {% set delta = electric_fallback_delta_c | float(0.5) %}
      {% set last_ts = as_timestamp(states(electric_fallback_last_trigger)) | float(0) %}
      {% set now_ts = now().timestamp() %}
      {% set cooldown_ok = (now_ts - last_ts) >= (electric_fallback_cooldown_minutes | float(60) * 60) %}
      {{ is_state(es_bool, 'off') and
         (comfort_min is number) and (comfort_min < (target - delta)) and cooldown_ok }}
    for:
      minutes: !input electric_fallback_minutes

condition: []

action:
  - variables:
      force_direct_electric: "{{ trigger.id == 'electric_fallback' }}"

  - choose:

      # --- ENERGY SAVING = ON ---
      - conditions:
          - condition: state
            entity_id: !input energy_saving_boolean
            state: "on"
        sequence:
          - variables:
              outdoor_temp: "{{ states(outdoor_temperature_sensor) | float(default=none) }}"
              cur_ctrl: "{{ states(controll_sensor) | float(default=none) }}"
              setpoint: "{{ heatpump_setpoint | float }}"
              min_c: "{{ mirror_min_c | float(-50) }}"
              max_c: "{{ mirror_max_c | float(50) }}"
              warm_shutdown: "{{ energy_saving_warm_shutdown_outdoor | float }}"
              cold_target: "{{ (setpoint - 1) | float }}"
              target_unclamped: >-
                {% if outdoor_temp is number and outdoor_temp >= warm_shutdown %}
                  {{ virtual_temperature | float }}
                {% else %}
                  {{ cold_target }}
                {% endif %}
              target: "{{ [max_c, [min_c, target_unclamped] | max] | min }}"
              mode_label: >-
                {% if outdoor_temp is number and outdoor_temp >= warm_shutdown %}
                  warm shutdown (virtual block)
                {% else %}
                  cold mode (setpoint-1)
                {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ cur_ctrl is number and target is number and
                         (cur_ctrl - target) | abs >= (min_write_delta | float) }}
                sequence:
                  - service: number.set_value
                    target:
                      entity_id: !input controll_sensor
                    data:
                      value: "{{ target }}"
          - service: logbook.log
            data:
              name: Block Heat
              message: >-
                Energy saving = ON → {{ mode_label }} at {{ target }} °C

      # --- ENERGY SAVING = OFF → COLD-BOOST CONTROL ---
      - conditions:
          - condition: state
            entity_id: !input energy_saving_boolean
            state: "off"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ force_direct_electric }}"
                sequence:
                  - variables:
                      cur_ctrl: "{{ states(controll_sensor) | float(default=none) }}"
                      min_c: "{{ mirror_min_c | float(-50) }}"
                      max_c: "{{ mirror_max_c | float(50) }}"
                      target_unclamped: "{{ direct_electric_min_c | float(18) }}"
                      target: "{{ [max_c, [min_c, target_unclamped] | max] | min }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: >-
                              {{ target is number and cur_ctrl is number and
                                 (target - cur_ctrl) | abs >= (min_write_delta | float) }}
                        sequence:
                          - service: number.set_value
                            target:
                              entity_id: !input controll_sensor
                            data:
                              value: "{{ target }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: !input electric_fallback_last_trigger
                    data:
                      timestamp: "{{ now().timestamp() | int }}"
            default:
              - alias: Control while energy saving stays OFF
                repeat:
                  until:
                    - condition: state
                      entity_id: !input energy_saving_boolean
                      state: "on"
                  sequence:
                    - variables:
                        room1_temp: "{{ states(comfort_room_1_sensor) | float(default=none) }}"
                        room2_temp: "{{ states(comfort_room_2_sensor) | float(default=none) }}"
                        storage_temp: "{{ states(storage_room_sensor) | float(default=none) }}"
                        comfort_min: >-
                          {% set temps = [room1_temp, room2_temp] | select('number') | list %}
                          {{ temps | min(default=none) }}
                        comfort_target: "{{ comfort_target_c | float(22) }}"
                        comfort_offset: "{{ comfort_to_heatpump_offset_c | float(2) }}"
                        storage_offset: "{{ storage_to_heatpump_offset_c | float(2) }}"
                        base_heatpump_target: "{{ comfort_target - comfort_offset }}"
                        comfort_margin: "{{ comfort_satisfied_margin_c | float(0.2) }}"
                        comfort_satisfied: >-
                          {{ room1_temp is number and room2_temp is number and
                             room1_temp >= (comfort_target - comfort_margin) and
                             room2_temp >= (comfort_target - comfort_margin) }}
                        outdoor_temp: "{{ states(outdoor_temperature_sensor) | float(default=none) }}"
                        cur_ctrl: "{{ states(controll_sensor) | float(default=none) }}"
                        min_c: "{{ mirror_min_c | float(-50) }}"
                        max_c: "{{ mirror_max_c | float(50) }}"
                        maint_target: "{{ maintenance_target_c | float(20) }}"
                        maint_min: "{{ maintenance_min_c | float(19) }}"
                        direct_min: "{{ direct_electric_min_c | float(18) }}"
                        storage_cap: "{{ storage_cap_c | float(25) }}"
                        storage_target: "{{ storage_target_c | float(25) }}"
                        effective_min: "{{ direct_min }}"
                        boost_raw: >-
                          {% if outdoor_temp is number and outdoor_temp < (cold_threshold | float) %}
                            {{ ((cold_threshold | float) - outdoor_temp) / (boost_slope_c | float(5)) }}
                          {% else %}
                            0
                          {% endif %}
                        boost_clamped: "{{ [max_boost | float, boost_raw | float] | min }}"
                        boost: >-
                          {% if comfort_min is number and comfort_min >= (comfort_target + (warm_margin | float)) %}
                            0
                          {% else %}
                            {{ boost_clamped }}
                          {% endif %}
                        comfort_target_unclamped: "{{ base_heatpump_target + (boost | float) }}"
                        storage_target_unclamped: >-
                          {{ (storage_target - storage_offset) + (boost | float) }}
                        storage_needs_heat: >-
                          {{ storage_temp is number and storage_temp < (storage_target - comfort_margin) }}
                        storage_cap_heatpump: "{{ storage_cap - storage_offset }}"
                        comfort_target_capped: >-
                          {{ [comfort_target_unclamped, storage_cap_heatpump] | min }}
                        storage_target_capped: >-
                          {{ [storage_target_unclamped, storage_cap_heatpump] | min }}
                        target_unclamped: >-
                          {% if comfort_satisfied and storage_needs_heat %}
                            {{ [storage_target_capped, comfort_target_capped] | max }}
                          {% elif comfort_satisfied %}
                            {{ maint_target }}
                          {% else %}
                            {{ comfort_target_capped }}
                          {% endif %}
                        target_min_applied: >-
                          {% if comfort_satisfied %}
                            {{ [target_unclamped, effective_min] | max }}
                          {% else %}
                            {{ target_unclamped }}
                          {% endif %}
                        target: "{{ [max_c, [min_c, target_min_applied] | max] | min }}"
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: >-
                                {{ target is number and cur_ctrl is number and
                                   (target - cur_ctrl) | abs >= (min_write_delta | float) }}
                          sequence:
                            - service: number.set_value
                              target:
                                entity_id: !input controll_sensor
                              data:
                                value: "{{ target }}"
                    - delay:
                        minutes: !input refresh_temperature_delay
          - service: logbook.log
            data:
              name: Block Heat
              message: >-
                Energy saving = OFF → cold-boost control every
                {{ refresh_temperature_delay }} min (clamped {{ mirror_min_c }}..{{ mirror_max_c }} °C)

    default: []
